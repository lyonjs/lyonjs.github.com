name: üßπ Preview cleanup
on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: üóëÔ∏è Delete preview container
    runs-on: ubuntu-latest
    env:
      SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
      SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
      SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
      SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
    steps:
      - name: Install Scaleway CLI
        run: curl -s https://raw.githubusercontent.com/scaleway/scaleway-cli/master/scripts/get.sh | sudo sh

      - name: Delete preview container
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          CONTAINER_NAME="preview-pr-${PR_NUMBER}"
          NAMESPACE_ID="${{ vars.SCW_PREVIEW_NAMESPACE_ID }}"

          # Find container by exact name match
          CONTAINER_ID=$(scw container container list \
            namespace-id="${NAMESPACE_ID}" \
            region=fr-par \
            -o json | jq -r --arg name "$CONTAINER_NAME" '.[] | select(.name == $name) | .id')

          if [ -n "$CONTAINER_ID" ]; then
            echo "Deleting container ${CONTAINER_ID} (${CONTAINER_NAME})"
            scw container container delete "${CONTAINER_ID}" region=fr-par
          else
            echo "No container found for ${CONTAINER_NAME}, skipping"
          fi

      - name: Delete SCR image tag
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          IMAGE_TAG="pr-${PR_NUMBER}"
          SCW_REGISTRY="${{ vars.SCW_REGISTRY_ENDPOINT }}"

          # List images and find the one with our tag
          IMAGE_ID=$(scw registry image list \
            -o json | jq -r --arg tag "$IMAGE_TAG" '.[] | select(.tags[]? == $tag) | .id')

          if [ -n "$IMAGE_ID" ]; then
            echo "Deleting image ${IMAGE_ID} with tag ${IMAGE_TAG}"
            scw registry image delete "${IMAGE_ID}"
          else
            echo "No image found with tag ${IMAGE_TAG}, skipping"
          fi
